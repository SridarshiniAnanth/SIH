<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Attendance System</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
   
    * { box-sizing: border-box; }
    body { font-family: 'Roboto', sans-serif; margin:0; padding:0; background:#f4f6f8; }
    h1, h3 { margin:0; }
    h1 { font-size: 28px; margin-bottom: 20px; text-align:center; color:#333; }
    
   
    .container { max-width: 600px; margin: 20px auto; padding: 10px; }

  
    #video { width: 100%; border-radius: 12px; border:2px solid #555; margin-bottom:12px; }

    
    .card {
      background: #ffffff;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      transition: transform 0.5s;
    }
    .card:hover { transform: translateY(-3px); }

    .card h3 { margin-bottom: 12px; color:#222; font-weight:500; }

    input[type="text"] {
      width: 100%;
      padding: 10px 12px;
      border:1px solid #ccc;
      border-radius:8px;
      margin-bottom:12px;
      font-size:16px;
      transition: 0.2s;
    }
    input[type="text"]:focus { border-color:#4CAF50; outline:none; }

    button {
      background: #4CAF50;
      color: #fff;
      border: none;
      padding: 10px 16px;
      font-size: 16px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s;
      display: block;       
      margin: 12px auto;    }

    button:hover { background: #45a049; }
    button:active { transform: scale(0.97); }

    #status, #reg_status, #ver_status, #coords { margin-top:10px; color:#555; font-size:14px; }

    
    #map {
      height: 250px;
      width: 100%;
      border-radius: 12px;
      margin-top: 12px;
      border:2px solid #ccc;
    }

   
    @media(max-width: 400px) {
      h1 { font-size:24px; }
      button { width: 100%; }
    }
  </style>
</head>
<body>

  <div class="container">
    <h1 style="color: #310000;">Smart Attendance System</h1>

    <hr>

    <video id="video" autoplay playsinline></video>
    <canvas id="canvas" width="320" height="240" style="display:none;"></canvas>

    
    <div class="card">
      <h2 style="text-align: center;">Register</h2>
      <input id="reg_username" type="text" placeholder="Enter username">
      <input id="reg_mail" type="text" placeholder="Enter Email-ID">
      <button id="btnReg">Start Register</button>
      <div id="reg_status"></div>
    </div>

    
    <div class="card">
      <h2 style="text-align: center;">Verify</h2>
      <input id="ver_username" type="text" placeholder="Enter username">
      <button id="btnVer">Start Verify</button>
      <div id="ver_status"></div>
    </div>

   
    <div class="card">
      <h2 style="text-align: center;">Map</h2>
      <div id="map"></div>
      <p id="coords"></p>
    </div>
  </div>

<script>
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
let streamStarted = false;
let map, marker;

async function startCamera(){
  if(streamStarted) return;
  try {
    const s = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
    video.srcObject = s;
    streamStarted = true;
  } catch (e) { alert("Camera access error: " + e); }
}
startCamera();

function captureFrame(){
  canvas.width = video.videoWidth || 320;
  canvas.height = video.videoHeight || 240;
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  return canvas.toDataURL("image/jpeg", 0.8);
}

function initMap(lat, lon){
  if(!map){
    map = L.map('map').setView([lat, lon], 16);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);
    marker = L.marker([lat, lon]).addTo(map);
  } else {
    map.setView([lat, lon], 16);
    marker.setLatLng([lat, lon]);
  }
}


document.getElementById("btnReg").onclick = async function(){
  const username = document.getElementById("reg_username").value.trim();
  if(!username){ alert("Enter username"); return; }
  const usermail = document.getElementById("reg_mail").value.trim();
  if(!usermail){ alert("Enter MailID"); return; }
  document.getElementById("reg_status").innerText = "Starting registration...";
  const start = Date.now();
  while(true){
    const res = await fetch("/register_frame", {
      method: "POST",
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({username,usermail, frame: captureFrame()})
    });
    const j = await res.json();
    document.getElementById("reg_status").innerText = j.message + ` (${j.saved_count || 0}/${j.required || 0})`;
    if(j.status === "done") break;
    if((Date.now() - start) > 60000) break;
    await new Promise(r=>setTimeout(r, 300));
  }
};


document.getElementById("btnVer").onclick = async function(){
  const username = document.getElementById("ver_username").value.trim();
  if(!username){ alert("Enter username"); return; }
  document.getElementById("ver_status").innerText = "Starting verification...";
  
  if(!navigator.geolocation){ alert("Geolocation not supported"); return; }

  navigator.geolocation.getCurrentPosition(async function(pos){
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;
    initMap(lat, lon);
    document.getElementById("coords").innerText = `Latitude: ${lat.toFixed(6)}, Longitude: ${lon.toFixed(6)}`;

    const start = Date.now();
    while(true){
      const res = await fetch("/verify_frame", {
        method: "POST",
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({username, frame: captureFrame(), latitude: lat, longitude: lon})
      });
      const j = await res.json();
      document.getElementById("ver_status").innerText = j.message;
      if(j.status === "verified"){
        
        if(j.map_path){
          const iframe = document.createElement("iframe");
          iframe.src = j.map_path;
          iframe.width = "100%";
          iframe.height = "240";
          document.getElementById("map").appendChild(iframe);
        }
        break;
      }
      if(j.status === "failed_final") break;
      if((Date.now() - start) > 15000) break;
      await new Promise(r=>setTimeout(r, 250));
    }

  }, function(err){ alert("Error getting location: " + err.message); });
};


  const verInput1 = document.getElementById("reg_username");
  const verButton1 = document.getElementById("btnReg");

  verInput1.addEventListener("keypress", function(event) {
    if (event.key === "Enter") {
      event.preventDefault(); 
      verButton1.click();
    }
  });

  
  const verInput2 = document.getElementById("ver_username");
  const verButton2 = document.getElementById("btnVer");

  verInput2.addEventListener("keypress", function(event) {
    if (event.key === "Enter") {
      event.preventDefault(); 
      verButton2.click();      
    }
  });
</script>
</body>
</html>
